<html>
<head>
<script src='https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js'></script>
<script>
  const hostPrefix = 'http://127.0.0.1:3000'
</script>
</head>
<body>
  <div id='progress'></div>
  <script>
const checkProgress = (token, callback) => {
  $.ajax({
    type: 'POST',
    url: `${hostPrefix}/client/configs`,
    data: JSON.stringify({
      token
    }),
    contentType: 'application/json',
    success: (result) => {
      if (result.hasOwnProperty(token) || result === 'REQUEST_CREATED') {
        $( '#progress' ).html($( '#progress' ).html() + '.')
        sleep(10000).then(() => checkProgress(token, callback))
        return
      }
      callback(result)
    }
  })
}

const sleep = (ms) => {
  return new Promise(resolve => setTimeout(resolve, ms));
}

const clientName = 'rampage'
const clientEmail = 'jaeichel@protonmail.com'

$.ajax({
  type: 'POST',
  url: `${hostPrefix}/client/configs`,
  data: JSON.stringify({
    clientName,
    clientEmail
  }),
  contentType: 'application/json',
  success: (result) => {
    const token = result.token
    console.log(token)
    $( '#progress' ).html('This might take several minutes. Creating DH keys...')

    sleep(10000).then(() => checkProgress(token, (config) => {
      $( '#progress' ).html('done')

      const link = document.createElement('a')
      link.download = `${clientName}-vpn.arrowlofts.net.ovpn`
      link.href = `data:application/ovpn,${encodeURIComponent(config)}`
      link.click();
    }))
  }
})
  </script>
</body>
</html>
